<launch>

  <arg name="localization"  default="false"/>
  <arg name="rtabmapviz"    default="false"/>
  <arg name="use_imu"       default="false"/> <!-- Assuming IMU fixed to lidar with /velodyne -> /imu_link TF -->
  <arg name="imu_topic"     default="/rtabmap/imu"/>
  <arg name="scan_20_hz"    default="false"/> <!-- If we launch the velodyne with "rpm:=1200" argument -->
  <arg name="organize_cloud" default="false"/>
  <arg name="use_sim_time"  default="true"/>
  <arg     if="$(arg localization)" name="args" default=""/>
  <arg unless="$(arg localization)" name="args" default="--delete_db_on_start"/>
  <param if="$(arg use_sim_time)" name="use_sim_time" value="true"/>
  <arg name="frame_id" default="base_link"/>
  
  <!-- PLEASE CHANGE THIS BLOCK OF CODE ACCORDING TO YOUR CONFIGURATIONS -->
  <!-- <arg name="lidar_cloud" default="/lslidar_c16/lslidar_point_cloud"/> -->
  <arg name="lidar_cloud" default="/lidar_point_cloud/filtered"/>
  <arg name="raw_imu_topic" default="/camera/imu/sample"/>
  <arg name="database_path" default="~/finale/rtabmap.db"/>

  <!-- Imu Filter -->
  <node if="$(arg use_imu)" pkg="imu_filter_madgwick" type="imu_filter_node" name="imu_filter">
    <remap from ="/imu/data_raw" to="$(arg raw_imu_topic)"/>
    <remap from ="/imu/data" to="$(arg imu_topic)"/>
    <param name="use_mag" value="false"/>
    <param name="publish_tf" value="false"/>
    <param name="world_frame" value="enu"/>
  </node>

  <!-- IMU orientation estimation and publish tf accordingly to os1_sensor frame -->
  <node if="$(arg use_imu)" pkg="rtabmap_ros_multi" type="imu_to_tf" name="imu_to_tf" >
    <remap from="imu/data" to="$(arg imu_topic)"/>
    <param name="fixed_frame_id" value="$(arg frame_id)_stabilized"/>
    <param name="base_frame_id" value="$(arg frame_id)"/>
  </node> 

  <group ns="rtabmap">
    <!-- Odometry -->
    <node pkg="rtabmap_ros_multi" type="icp_odometry" name="icp_odometry" output="screen" args="$(arg args)">
      <rosparam file="$(find rtabmap_pcl_slam_handler)/config/odom_lpm.yaml"/>

      <remap from="scan_cloud" to="$(arg lidar_cloud)"/> 
      <param name="frame_id"        type="string" value="$(arg frame_id)"/>  
      <param name="odom_frame_id"   type="string" value="odom"/>
      <param     if="$(arg scan_20_hz)" name="expected_update_rate" type="double" value="25"/>
      <param unless="$(arg scan_20_hz)" name="expected_update_rate" type="double" value="15"/>

      <remap if="$(arg use_imu)" from="imu" to="$(arg imu_topic)"/>
      <param if="$(arg use_imu)" name="guess_frame_id"   type="string" value="$(arg frame_id)_stabilized"/>
      <param if="$(arg use_imu)" name="wait_imu_to_init" type="bool" value="true"/>
    </node>

    <!-- SLAM -->
    <node pkg="rtabmap_ros_multi" type="rtabmap" name="rtabmap" output="screen" args="$(arg args)">	  
      <rosparam file="$(find rtabmap_pcl_slam_handler)/config/slam_rtabmap.yaml"/>

      <param name="database_path"       type="string" value="$(arg database_path)"/>
      <remap from="scan_cloud" to="assembled_cloud"/>
      <remap from="imu" to="$(arg imu_topic)"/>
      
      <!-- localization mode -->
      <param     if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
      <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
      <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)"/> 

      <remap from="/rtabmap/grid_map" to="/map"/>
      <remap from="/rtabmap/cloud_map" to="/map_3d"/>
    </node>

    <!-- Visualization -->
    <node if="$(arg rtabmapviz)" name="rtabmapviz" pkg="rtabmap_ros_multi" type="rtabmapviz" output="screen">
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <param name="odom_frame_id" type="string" value="odom"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
      <param name="subscribe_scan_cloud" type="bool" value="true"/>
      <param name="approx_sync" type="bool" value="false"/>
      <remap from="scan_cloud" to="$(arg lidar_cloud)"/>
    </node>

    <!-- Assembler -->
    <node pkg="nodelet" type="nodelet" name="point_cloud_assembler" args="standalone rtabmap_ros_multi/point_cloud_assembler" output="screen">
      <remap from="cloud"           to="$(arg lidar_cloud)"/>
      <remap from="odom"            to="odom"/>
      <param     if="$(arg scan_20_hz)" name="max_clouds"      type="int"    value="20" />
      <param unless="$(arg scan_20_hz)" name="max_clouds"      type="int"    value="10" />
      <param name="fixed_frame_id"  type="string" value="" />
    </node>
</group>

<node pkg="rtabmap_pcl_slam_handler" type="pointcloud_saver" name="pointcloud_saver">
  <rosparam file="$(find rtabmap_pcl_slam_handler)/config/pointcloud_saver.yaml"/>
</node>

</launch>