<?xml version="1.0" encoding="UTF-8"?>
<launch>

  <arg name="mode" default="$(env MOVEL_MODE)" doc="mode: [deployment, development]"/>
  
  <!-- For rtabmap -->
  <arg name="localization" default="true"/>
  <arg name="database_path" default="~/.config/movel/maps/rtabmap.db"/>

  <arg name="rgb_topic" default="/camera/color/image_raw"/>
  <arg name="depth_topic" default="/camera/aligned_depth_to_color/image_raw"/>
  <arg name="camera_info_topic" default="/camera/color/camera_info"/>
  <arg name="depth_camera_info_topic" default="/camera/depth/camera_info"/>

  <group if="$(eval mode == 'deployment')">
    <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
      <param name="base_global_planner" value="global_planner/GlobalPlanner"/>
      <remap from="cmd_vel" to="cmd_vel_mux/autonomous"/>
      <remap from="map" to="map_nav" />

      <rosparam file="$(find movel)/config/costmap_common_params.yaml" ns="global_costmap"/>
      <rosparam file="$(find movel)/config/costmap_common_params.yaml" ns="local_costmap"/>
      <rosparam file="$(find movel)/config/local_costmap_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/global_costmap_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/base_local_planner_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/move_base_params.yaml" command="load"/>

      <rosparam file="$(env HOME)/.config/movel/config/movel/config/base_local_planner_params.yaml" command="load"/>
      <rosparam file="$(env HOME)/.config/movel/config/movel/config/global_costmap_params.yaml" command="load"/>
      <rosparam file="$(env HOME)/.config/movel/config/movel/config/costmap_common_params.yaml" ns="local_costmap"/>
      <rosparam file="$(env HOME)/.config/movel/config/movel/config/costmap_common_params.yaml" ns="global_costmap"/>
      <rosparam file="$(env HOME)/.config/movel/config/movel/config/local_costmap_params.yaml" command="load"/>
      <rosparam file="$(env HOME)/.config/movel/config/movel/config/move_base_params.yaml" command="load"/>
    </node>

    <remap from="/rtabmap/initialpose" to="/initialpose"/>
    <include file="$(find movel)/launch/rtabmap_nav.launch">
        <arg unless="$(arg localization)" name="args" value="--delete_db_on_start"/>
        <arg name="localization" value="$(arg localization)"/>
        
        <arg name="rgb_topic" value="$(arg rgb_topic)"/>
        <arg name="depth_topic" value="$(arg depth_topic)"/>
        <arg name="camera_info_topic" value="$(arg camera_info_topic)"/>
        <arg name="depth_camera_info_topic" value="$(arg depth_camera_info_topic)"/>
        
        <arg name="rtabmapviz" value="false"/>
        <arg name="rviz" value="false"/>
        <arg name="database_path" value="$(arg database_path)"/>
        <arg name="output" value="log"/>
        <arg name="frame_id" value="base_link"/>
    </include>
  </group>

  <group unless="$(eval mode == 'deployment')">
    <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
      <param name="base_global_planner" value="global_planner/GlobalPlanner"/>
      <remap from="cmd_vel" to="cmd_vel_mux/autonomous"/>
      <remap from="map" to="map_nav" />

      <rosparam file="$(find movel)/config/costmap_common_params.yaml" ns="global_costmap"/>
      <rosparam file="$(find movel)/config/costmap_common_params.yaml" ns="local_costmap"/>
      <rosparam file="$(find movel)/config/local_costmap_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/global_costmap_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/base_local_planner_params.yaml" command="load"/>
      <rosparam file="$(find movel)/config/move_base_params.yaml" command="load"/>
    </node>

    <remap from="/rtabmap/initialpose" to="/initialpose"/>
    <include file="$(find movel)/launch/rtabmap_nav.launch">
        <arg unless="$(arg localization)" name="args" value="--delete_db_on_start"/>
        <arg name="localization" value="$(arg localization)"/>
        
        <arg name="rgb_topic" value="$(arg rgb_topic)"/>
        <arg name="depth_topic" value="$(arg depth_topic)"/>
        <arg name="camera_info_topic" value="$(arg camera_info_topic)"/>
        <arg name="depth_camera_info_topic" value="$(arg depth_camera_info_topic)"/>
        
        <arg name="rtabmapviz" value="false"/>
        <arg name="rviz" value="false"/>
        <arg name="database_path" value="$(arg database_path)"/>
        <arg name="output" value="log"/>
        <arg name="frame_id" value="base_link"/>
    </include>
  </group>

  <include file="$(find obstacle_detector)/launch/nodes_pcl.launch" />
  <include file="$(find velocity_setter)/launch/velocity_setter.launch" />
  <include file="$(find plan_inspector)/launch/plan_inspector.launch" />
  <include file="$(find movel_fms_utils)/launch/plan_measurer.launch" />
  <include file="$(find movel_fms_utils)/launch/plan_decimator.launch" />
  <include file="$(find planner_utils)/launch/planner_utils.launch" />

</launch>
